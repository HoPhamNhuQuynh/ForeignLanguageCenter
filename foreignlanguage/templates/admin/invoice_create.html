{% extends 'admin/master.html' %}

{% block body %}
<style>
    .bg-orange { background-color: var(--primary-orange) !important; color: white; }
    .text-orange { color: var(--primary-orange) !important; }
    .border-orange { border-color: var(--primary-orange) !important; }

    .btn-orange {
        background-color: var(--primary-orange);
        color: white;
        border: none;
        transition: all 0.2s;
    }

    .btn-orange:hover { background-color: var(--dark-orange); color: white; transform: translateY(-1px); }

    /* 3. BẢNG DỮ LIỆU */
    .student-row { cursor: pointer; transition: background-color 0.15s; }
    .student-row:hover { background-color: var(--light-orange); }
    .row-active {
        background-color: #ffe0b2 !important;
        border-left: 4px solid var(--dark-orange);
    }

    /* 4. OPTION CARDS (MỨC THANH TOÁN) */
    .option-card {
        cursor: pointer;
        border: 2px solid #dee2e6;
        transition: all 0.2s ease-in-out;
        height: 100%; /* Để 2 ô cao bằng nhau */
    }
    /* Khi radio bên trong được checked thì đổi màu viền cha */
    .option-card:has(input:checked) {
        border-color: var(--primary-orange);
        background-color: #fffbf7;
    }
    .option-card.disabled {
        background-color: #e9ecef;
        opacity: 0.7;
        cursor: not-allowed;
        border-color: #dee2e6;
    }

    /* 5. HIỂN THỊ TIỀN */
    .amount-display {
        font-size: 1.75rem;
        font-weight: 800;
        color: #d32f2f;
        background-color: #fff;
        border: none;
        border-bottom: 2px solid #dee2e6;
    }
</style>

<div class="container-fluid py-4 bg-light" style="min-height: 100vh;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="text-uppercase fw-bold text-dark mb-0">Lập Phiếu Thu</h4>
            <small class="text-muted">Thu ngân: {{ current_user.name }}</small>
        </div>
        <button onclick="window.location.reload()" class="btn btn-white border shadow-sm text-secondary">
            <i class="fa fa-refresh me-1"></i> Làm mới
        </button>
    </div>

    <div class="row g-4">
        <div class="col-lg-4 col-md-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3 border-bottom">
                    <h6 class="m-0 fw-bold text-orange"><i class="fa fa-users me-2"></i>Học viên nợ học phí</h6>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    <div class="p-3 bg-light border-bottom">
                        <form method="GET">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i class="fa fa-search text-muted"></i></span>
                                <input type="text" name="search" class="form-control border-start-0 ps-0" placeholder="Tên hoặc SĐT..." value="{{ request.args.get('search', '') }}">
                                <button class="btn btn-orange" type="submit">Tìm</button>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive flex-grow-1" style="max-height: 600px;">
                        <table class="table mb-0 align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th class="ps-3 py-2">Thông tin</th>
                                    <th class="text-end pe-3 py-2">Nợ (VNĐ)</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for r in registrations %}
                            {% set debt = r.actual_tuition - r.paid %}
                            <tr class="student-row border-bottom"
                                onclick="selectRow(this, '{{ r.id }}', '{{ r.student.account.name }}', '{{ r.classroom.course_level.course.name }}', {{ r.actual_tuition }}, {{ debt }})">
                                <td class="ps-3 py-3">
                                    <div class="fw-bold text-dark">{{ r.student.account.name }}</div>
                                    <div class="small text-muted"><i class="fa fa-book me-1"></i>{{ r.classroom.course_level.course.name }}</div>
                                </td>
                                <td class="text-end pe-3 text-danger fw-bold">
                                    {{ "{:,.0f}".format(debt) }}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="2" class="text-center p-4 text-muted">Không tìm thấy dữ liệu phù hợp</td></tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white small text-muted text-center py-2">
                        Hiển thị {{ registrations|length }} kết quả
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-md-7">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-orange text-white py-3">
                    <h5 class="m-0 fw-bold text-uppercase text-center"><i class="fa fa-file-invoice-dollar me-2"></i>Thông tin thanh toán</h5>
                </div>
                <div class="card-body p-4">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for cat, msg in messages %}
                                <div class="alert alert-{{ cat }} alert-dismissible fade show shadow-sm border-0 mb-4" role="alert">
                                    <i class="fa fa-info-circle me-2"></i> {{ msg }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" id="invoiceForm">
                        <input type="hidden" name="regis_id" id="inp_regis_id" required>

                        <h6 class="text-uppercase text-muted fw-bold small mb-3">1. Thông tin phiếu</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Học viên</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fa fa-user"></i></span>
                                    <input type="text" class="form-control bg-light fw-bold text-dark" id="inp_name" readonly placeholder="--">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Khóa học</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fa fa-graduation-cap"></i></span>
                                    <input type="text" class="form-control bg-light fw-bold text-dark" id="inp_course" readonly placeholder="--">
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label small fw-bold">Nội dung thu</label>
                                <input type="text" name="content" id="inp_content" class="form-control" required placeholder="Nhập nội dung...">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Ngày lập</label>
                                <input type="date" name="created_date" class="form-control bg-light text-center"
                                       value="{{ today_str }}" readonly style="pointer-events: none;">
                            </div>
                        </div>

                        <hr class="text-muted opacity-25">

                        <h6 class="text-uppercase text-muted fw-bold small mb-3">2. Mức thanh toán</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="option-card p-3 rounded d-block position-relative" id="card_full">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_opt" id="opt_full" onchange="updateAmount(this.value)" disabled>
                                        <label class="form-check-label fw-bold w-100" for="opt_full">
                                            Thanh toán Hết (100%)
                                        </label>
                                    </div>
                                    <div class="mt-2 text-end">
                                        <span class="badge bg-success rounded-pill" id="lbl_full_amount">0 ₫</span>
                                    </div>
                                    <div class="small text-muted mt-1 fst-italic">Hoàn tất học phí khóa học</div>
                                </label>
                            </div>

                            <div class="col-md-6">
                                <label class="option-card p-3 rounded d-block position-relative" id="card_half">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_opt" id="opt_half" onchange="updateAmount(this.value)" disabled>
                                        <label class="form-check-label fw-bold w-100" for="opt_half">
                                            Thanh toán 50%
                                        </label>
                                    </div>
                                    <div class="mt-2 text-end">
                                        <span class="badge bg-warning text-dark rounded-pill" id="lbl_half_amount">0 ₫</span>
                                    </div>
                                    <div class="small text-muted mt-1 fst-italic">Chỉ áp dụng cho lần đóng đầu tiên</div>
                                </label>
                            </div>
                        </div>

                        <div class="bg-light p-4 rounded-3 border">
                            <div class="row align-items-end g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Hình thức:</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="method" id="mCash" value="CASH" checked>
                                            <label class="form-check-label" for="mCash"><i class="fa fa-money-bill-wave text-success me-1"></i>Tiền mặt</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="method" id="mBank" value="BANKING">
                                            <label class="form-check-label" for="mBank"><i class="fa fa-university text-primary me-1"></i>Chuyển khoản</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <label class="form-label small text-uppercase text-muted fw-bold mb-0">Thực thu:</label>
                                    <input type="text" class="form-control amount-display text-end bg-transparent p-0" id="display_amount_text" value="0 ₫" readonly>
                                    <input type="hidden" name="amount" id="inp_amount_hidden">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4 pt-2 border-top">
                            <button type="button" onclick="resetForm()" class="btn btn-light border px-4 py-2">Hủy bỏ</button>
                            <button type="submit" id="btnSubmit" class="btn btn-orange px-5 py-2 fw-bold shadow-sm" disabled>
                                <i class="fa fa-print me-2"></i> LẬP PHIẾU THU
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

</script>
{% endblock %}