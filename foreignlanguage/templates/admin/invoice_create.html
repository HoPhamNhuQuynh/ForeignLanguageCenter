{% extends 'admin/master.html' %}

{% block body %}
<style>
    :root {
        --primary-orange: #ff9800;
        --light-orange: #fff3e0;
        --dark-orange: #f57c00;
    }

    .card-list {
        border-top: 4px solid var(--primary-orange);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .card-invoice {
        background: #fff;
        border: 1px solid #ddd;
        box-shadow: 0 10px 20px rgba(0,0,0,0.15); /* T·∫°o hi·ªáu ·ª©ng t·ªù h√≥a ƒë∆°n n·ªïi */
        position: sticky;
        top: 20px; /* C·ªë ƒë·ªãnh form khi cu·ªôn */
    }

    .card-invoice-header {
        background: var(--primary-orange);
        color: white;
        padding: 15px;
        text-align: center;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 1px;
    }

    .table-hover tbody tr:hover {
        background-color: var(--light-orange);
        cursor: pointer;
    }

    /* Class active khi ch·ªçn 1 d√≤ng */
    .row-active {
        background-color: #ffe0b2 !important; /* Cam ƒë·∫≠m h∆°n */
        border-left: 5px solid var(--dark-orange);
    }

    .form-control-custom {
        border-radius: 0;
        border: none;
        border-bottom: 2px solid #ccc;
        background: transparent;
        padding-left: 0;
    }

    .form-control-custom:focus {
        box-shadow: none;
        border-color: var(--primary-orange);
    }

    .form-control-custom[readonly] {
        background-color: transparent;
        color: #555;
        font-weight: 600;
    }

    .money-highlight {
        font-size: 1.25rem;
        color: #d32f2f; /* M√†u ƒë·ªè cho ti·ªÅn n·ª£ */
        font-weight: bold;
    }
</style>

<div class="container-fluid pt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-uppercase font-weight-bold" style="color: #333;">L·∫≠p Phi·∫øu Thu</h3>
            <p class="text-muted mb-0"><i class="fa fa-user-circle"></i> Thu ng√¢n: {{ current_user.name }}</p>
        </div>
        <div>
            <a href="{{ url_for('invoice.index') }}" class="btn btn-outline-secondary btn-sm" title="L√†m m·ªõi">
                <i class="fa fa-refresh"></i> T·∫£i l·∫°i trang
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5 col-md-12 mb-4">

            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body p-3">
                    <form method="GET" action="{{ url_for('invoice.index') }}">
                        <div class="input-group">
                            <input type="text" name="search" class="form-control border-right-0"
                                   placeholder="üîç T√¨m SƒêT, T√™n ho·∫∑c M√£ ƒêK..."
                                   value="{{ request.args.get('search', '') }}">
                            <div class="input-group-append">
                                <button class="btn btn-warning text-white" type="submit">T√¨m ki·∫øm</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card card-list border-0">
                <div class="card-header bg-white font-weight-bold">
                    <i class="fa fa-list-ul text-warning mr-2"></i> Danh s√°ch ch·ªù thanh to√°n
                </div>
                <div class="card-body p-0 table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover mb-0" id="debtTable">
                        <thead class="thead-light">
                        <tr>
                            <th>Th√¥ng tin h·ªçc vi√™n</th>
                            <th class="text-right">C√≤n n·ª£</th>
                            <th class="text-center" width="60px">#</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for r in registrations %}
                        {% set debt = r.actual_tuition - r.paid %}
                        <tr class="student-row"
                            id="row-{{ r.id }}"
                            onclick="selectRow(this, '{{ r.id }}', '{{ r.student.name }}', '{{ r.classroom.course.name }}', {{ debt }})">

                            <td class="align-middle">
                                <span class="font-weight-bold text-dark">{{ r.student.name }}</span><br>
                                <small class="text-muted"><i class="fa fa-phone"></i> {{ r.student.phone_num
                                    }}</small><br>
                                <span class="badge badge-info mt-1">{{ r.classroom.course.name }}</span>
                            </td>

                            <td class="align-middle text-right">
                                <span class="text-danger font-weight-bold">{{ "{:,.0f}".format(debt) }}</span>
                                <small>‚Ç´</small>
                            </td>

                            <td class="align-middle text-center">
                                <button class="btn btn-sm btn-outline-warning rounded-circle">
                                    <i class="fa fa-chevron-right"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center py-4 text-muted">
                                <i class="fa fa-search fa-2x mb-2"></i><br>
                                Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-white text-muted small">
                    Hi·ªÉn th·ªã {{ registrations|length }} k·∫øt qu·∫£
                </div>
            </div>
        </div>

        <div class="col-lg-7 col-md-12">
            <div class="card card-invoice">
                <div class="card-invoice-header">
                    <i class="fa fa-file-text-o mr-2"></i> Th√¥ng tin phi·∫øu thu
                </div>

                <div class="card-body p-4">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show mb-4">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <form method="POST" id="invoiceForm">
                        <input type="hidden" name="regis_id" id="inp_regis_id" required>

                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label class="text-muted small text-uppercase">H·ªçc vi√™n</label>
                                <input type="text" class="form-control form-control-custom" id="inp_name"
                                       placeholder="-- Ch∆∞a ch·ªçn --" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="text-muted small text-uppercase">Kh√≥a h·ªçc ƒëƒÉng k√Ω</label>
                                <input type="text" class="form-control form-control-custom" id="inp_course"
                                       placeholder="--" readonly>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="font-weight-bold">Ng√†y n·ªôp</label>
                                <input type="date"
                                       name="created_date"
                                       class="form-control form-control-custom text-dark"
                                       value="{{ today_str }}"
                                       required>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="font-weight-bold text-dark h5">S·ªë ti·ªÅn thanh to√°n (VNƒê)</label>
                                <div class="input-group input-group-lg">
                                    <input type="number" name="amount"
                                           class="form-control border-warning text-primary font-weight-bold"
                                           id="inp_amount" placeholder="0" required min="1000">
                                    <div class="input-group-append">
                                        <span class="input-group-text bg-warning text-white font-weight-bold">‚Ç´</span>
                                    </div>
                                </div>
                                <small class="form-text text-danger mt-1">
                                    * T·ªëi ƒëa c·∫ßn ƒë√≥ng: <span id="lbl_debt_limit" class="font-weight-bold">0</span> ‚Ç´
                                </small>
                            </div>

                            <div class="col-12 mb-4">
                                <label class="font-weight-bold">H√¨nh th·ª©c thanh to√°n</label>
                                <div class="d-flex mt-2">
                                    <div class="custom-control custom-radio mr-4">
                                        <input type="radio" id="methodCash" name="method" value="CASH"
                                               class="custom-control-input" checked>
                                        <label class="custom-control-label" for="methodCash"><i
                                                class="fa fa-money text-success"></i> Ti·ªÅn m·∫∑t</label>
                                    </div>
                                    <div class="custom-control custom-radio">
                                        <input type="radio" id="methodBank" name="method" value="BANKING"
                                               class="custom-control-input">
                                        <label class="custom-control-label" for="methodBank"><i
                                                class="fa fa-university text-primary"></i> Chuy·ªÉn kho·∫£n
                                            (Banking)</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-3 pt-3 border-top">
                            <button type="button" onclick="resetForm()" class="btn btn-light mr-2">H·ªßy b·ªè</button>
                            <button type="submit"
                                    class="btn btn-warning btn-lg font-weight-bold text-white px-5 shadow-sm"
                                    id="btnSubmit" disabled>
                                <i class="fa fa-print"></i> L·∫¨P PHI·∫æU & IN
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // H√†m reset form ƒë∆°n gi·∫£n
    function resetForm() {
        document.getElementById('invoiceForm').reset();
        document.getElementById('btnSubmit').disabled = true;
        document.querySelectorAll('.student-row').forEach(r => r.classList.remove('row-active'));
        document.getElementById('lbl_debt_limit').innerText = "0";
    }

    // Gi·ªØ nguy√™n h√†m selectRow c≈© c·ªßa b·∫°n
    function selectRow(row, id, name, course, debt) {
        document.querySelectorAll('.student-row').forEach(r => r.classList.remove('row-active'));
        row.classList.add('row-active');

        document.getElementById('inp_regis_id').value = id;
        document.getElementById('inp_name').value = name;
        document.getElementById('inp_course').value = course;

        document.getElementById('inp_amount').value = debt;
        document.getElementById('lbl_debt_limit').innerText = new Intl.NumberFormat('vi-VN').format(debt);

        document.getElementById('btnSubmit').disabled = false;
        document.getElementById('btnSubmit').classList.remove('btn-secondary');
        document.getElementById('btnSubmit').classList.add('btn-warning');
    }
</script>
{% endblock %}