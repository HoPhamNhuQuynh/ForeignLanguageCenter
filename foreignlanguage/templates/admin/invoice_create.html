{% extends 'admin/master.html' %}

{% block body %}
<style>
    /* 1. MÀU SẮC THƯƠNG HIỆU (Giữ nguyên) */
    :root { --primary-orange: #FF6B4A; --dark-orange: #e55a3b; }

    /* 2. CÁC CLASS TÙY CHỈNH TỐI THIỂU */
    .bg-orange { background-color: var(--primary-orange) !important; color: white; }
    .text-orange { color: var(--primary-orange) !important; }
    .btn-orange { background-color: var(--primary-orange); color: white; border: none; }
    .btn-orange:hover { background-color: var(--dark-orange); color: white; }

    /* Highlight dòng được chọn */
    .row-active { background-color: #ffe0b2 !important; border-left: 5px solid var(--dark-orange); }

    /* Input hiển thị tiền to rõ */
    .amount-display {
        font-size: 1.5rem; font-weight: 800; color: #d32f2f;
        background-color: #f8f9fa; border: none; border-bottom: 2px solid #dee2e6;
    }
</style>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-uppercase fw-bold text-dark">Lập Phiếu Thu</h4>
        <button onclick="window.location.reload()" class="btn btn-outline-secondary btn-sm">
            <i class="fa fa-refresh"></i> Tải lại
        </button>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-bottom">
                    <i class="fa fa-list text-orange me-2"></i>Danh sách nợ học phí
                </div>
                <div class="card-body p-0">
                    <div class="p-3 border-bottom">
                        <form method="GET">
                            <div class="input-group">
                                <input type="text" name="search" class="form-control" placeholder="Tìm tên, SĐT..." value="{{ request.args.get('search', '') }}">
                                <button class="btn btn-orange" type="submit"><i class="fa fa-search"></i></button>
                            </div>
                        </form>
                    </div>

                    <div class="table-responsive" style="max-height: 500px;">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Học viên</th>
                                    <th class="text-end pe-3">Nợ (VNĐ)</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for r in registrations %}
                            {% set debt = r.actual_tuition - r.paid %}
                            <tr class="student-row" style="cursor: pointer;"
                                onclick="selectRow(this, '{{ r.id }}', '{{ r.student.name }}', '{{ r.classroom.course.name }}', {{ r.actual_tuition }}, {{ debt }})">
                                <td class="ps-3">
                                    <div class="fw-bold">{{ r.student.name }}</div>
                                    <small class="text-muted">{{ r.classroom.course.name }}</small>
                                </td>
                                <td class="text-end pe-3 text-danger fw-bold">
                                    {{ "{:,.0f}".format(debt) }}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="2" class="text-center p-3 text-muted">Không tìm thấy dữ liệu</td></tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-orange text-center py-3">
                    <h5 class="mb-0 fw-bold text-uppercase">Thông tin thanh toán</h5>
                </div>
                <div class="card-body p-4">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for cat, msg in messages %}
                                <div class="alert alert-{{ cat }} py-2 small">{{ msg }}</div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" id="invoiceForm">
                        <input type="hidden" name="regis_id" id="inp_regis_id" required>

                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted text-uppercase fw-bold">Học viên</label>
                                <input type="text" class="form-control bg-light" id="inp_name" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted text-uppercase fw-bold">Khóa học</label>
                                <input type="text" class="form-control bg-light" id="inp_course" readonly>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Nội dung</label>
                                <input type="text" name="content" id="inp_content" class="form-control" required placeholder="Nội dung thu...">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Ngày lập</label>
                                <input type="date" name="created_date" class="form-control bg-light"
                                       value="{{ today_str }}" readonly style="pointer-events: none;">
                            </div>
                        </div>

                        <hr class="text-muted opacity-25">

                        <div class="mb-4">
                            <label class="form-label fw-bold h6">Mức thanh toán</label>

                            <div class="form-check border rounded p-3 mb-2 bg-light">
                                <input class="form-check-input mt-1" type="radio" name="payment_opt" id="opt_full" onchange="updateAmount(this.value)" disabled>
                                <label class="form-check-label w-100 fw-bold ps-2" for="opt_full">
                                    Thanh toán hết (Hoàn tất)
                                    <span class="float-end text-success" id="lbl_full_amount">0 ₫</span>
                                </label>
                            </div>

                            <div class="form-check border rounded p-3 bg-light">
                                <input class="form-check-input mt-1" type="radio" name="payment_opt" id="opt_half" onchange="updateAmount(this.value)" disabled>
                                <label class="form-check-label w-100 fw-bold ps-2" for="opt_half">
                                    Thanh toán 50% (Trả góp)
                                    <span class="float-end text-warning" id="lbl_half_amount">0 ₫</span>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label text-muted small text-uppercase fw-bold">Số tiền thực thu</label>
                            <input type="text" class="form-control amount-display text-end" id="display_amount_text" value="0 ₫" readonly>
                            <input type="hidden" name="amount" id="inp_amount_hidden">
                        </div>

                        <div class="mb-4">
                            <div class="d-flex gap-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="method" id="mCash" value="CASH" checked>
                                    <label class="form-check-label" for="mCash"><i class="fa fa-money text-success"></i> Tiền mặt</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="method" id="mBank" value="BANKING">
                                    <label class="form-check-label" for="mBank"><i class="fa fa-university text-primary"></i> Chuyển khoản</label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" onclick="resetForm()" class="btn btn-light px-4">Hủy</button>
                            <button type="submit" id="btnSubmit" class="btn btn-orange px-5 fw-bold shadow-sm" disabled>
                                <i class="fa fa-check-circle me-2"></i>XÁC NHẬN
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const fmt = new Intl.NumberFormat('vi-VN');

    function resetForm() {
        document.getElementById('invoiceForm').reset();
        document.getElementById('btnSubmit').disabled = true;
        document.querySelectorAll('.student-row').forEach(r => r.classList.remove('row-active'));

        // Reset hiển thị
        document.getElementById('display_amount_text').value = "0 ₫";
        document.getElementById('inp_amount_hidden').value = "";
        document.getElementById('lbl_full_amount').innerText = "0 ₫";
        document.getElementById('lbl_half_amount').innerText = "0 ₫";

        // Disable radio
        document.getElementById('opt_full').disabled = true;
        document.getElementById('opt_half').disabled = true;
    }

    function updateAmount(value) {
        document.getElementById('inp_amount_hidden').value = value;
        document.getElementById('display_amount_text').value = fmt.format(value) + " ₫";
    }

    function selectRow(row, id, name, course, actualTuition, debt) {
        // Highlight
        document.querySelectorAll('.student-row').forEach(r => r.classList.remove('row-active'));
        row.classList.add('row-active');

        // Điền Form
        document.getElementById('inp_regis_id').value = id;
        document.getElementById('inp_name').value = name;
        document.getElementById('inp_course').value = course;
        document.getElementById('inp_content').value = "Thu học phí: " + course;

        // Logic tính toán 50%
        let halfTuition = actualTuition / 2;

        // Setup Full Option
        let optFull = document.getElementById('opt_full');
        optFull.disabled = false;
        optFull.value = debt;
        optFull.checked = true;
        document.getElementById('lbl_full_amount').innerText = fmt.format(debt) + " ₫";

        // Setup Half Option
        let optHalf = document.getElementById('opt_half');
        // Chỉ cho đóng 50% nếu nợ > 50% + sai số (tức là chưa đóng lần nào)
        if (debt > halfTuition + 1000) {
            optHalf.disabled = false;
            optHalf.value = halfTuition;
            document.getElementById('lbl_half_amount').innerText = fmt.format(halfTuition) + " ₫";
        } else {
            optHalf.disabled = true;
            document.getElementById('lbl_half_amount').innerText = "(Đã đóng đợt 1)";
        }

        updateAmount(debt);
        document.getElementById('btnSubmit').disabled = false;
    }
</script>
{% endblock %}