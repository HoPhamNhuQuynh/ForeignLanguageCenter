{% extends 'admin/master.html' %}

{% block body %}

<style>
    /* Tạo thanh cuộn cho bảng trong Modal nếu danh sách lớp dài */
    .table-scrollable-body {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }

    /* Hiệu ứng hover cho dòng trong bảng */
    .student-row:hover {
        background-color: #e9ecef;
    }

    /* Input readonly màu xám nhẹ cho dễ phân biệt */
    .form-control[readonly] {
        background-color: #f8f9fa;
        color: #495057;
    }
</style>

<div class="container-fluid py-4 bg-light" style="min-height: 100vh;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="text-uppercase fw-bold text-dark mb-0">Lập Phiếu Thu</h4>
            <small class="text-muted">Thu ngân: {{ current_user.name }}</small>
        </div>
        <div class="d-flex">
            <button type="button" class="btn btn-primary mr-3" data-toggle="modal" data-target="#manualInvoiceModal">
                <i class="fa fa-plus-circle me-2"></i> Tự tạo hóa đơn
            </button>
            <button onclick="window.location.reload()" class="btn btn-white border shadow-sm text-secondary">
                <i class="fa fa-refresh me-1"></i> Làm mới
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 col-md-5">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h6 class="m-0 fw-bold text-orange"><i class="fa fa-users mr-2"></i>Học viên nợ học phí</h6>
                </div>

                <div class="p-3 bg-light">
                    <form method="GET">
                        <div class="input-group">
                            <span class="input-group-text bg-white"><i class="fa fa-search text-muted"></i></span>
                            <input type="text" name="search" class="form-control border-start-0 ps-0"
                                   placeholder="Tên hoặc SĐT..." value="{{ request.args.get('search', '') }}">
                            <button class="btn btn-orange" type="submit">Tìm</button>
                        </div>
                    </form>
                </div>

                <div class="table-responsive" style="max-height: 600px;">
                    <table class="table mb-0 align-middle table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="ps-3 py-2">Thông tin</th>
                                <th class="text-end pe-3 py-2">Nợ (VNĐ)</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for r in registrations %}
                            {% set debt = r.actual_tuition - r.paid %}
                            <tr class="student-row border-bottom" style="cursor: pointer;"
                                onclick="selectRow(this, '{{ r.id }}', '{{ r.student.account.name }}', '{{ r.classroom.course_level.course.name }}', {{ r.actual_tuition }}, {{ debt }})">
                                <td class="ps-3 py-3">
                                    <div class="fw-bold text-dark text-wrap-custom">{{ r.student.account.name }}</div>
                                    <div class="small text-muted text-wrap-custom">
                                        <i class="fa fa-book me-1"></i>{{ r.classroom.course_level.course.name }}
                                    </div>
                                </td>
                                <td class="text-end pe-3 text-danger fw-bold text-nowrap">
                                    {{ "{:,.0f}".format(debt) }}
                                </td>
                            </tr>
                        {% else %}
                            <tr><td colspan="2" class="text-center p-4 text-muted">Không tìm thấy dữ liệu phù hợp</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-md-7">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-orange text-white py-3">
                    <h5 class="m-0 fw-bold text-center">
                        <i class="fa fa-file-invoice-dollar me-2"></i>THÔNG TIN THANH TOÁN
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="invoiceForm">
                        <input type="hidden" name="regis_id" id="inp_regis_id" required>

                        <h6 class="text-muted fw-bold small mb-3">1. THÔNG TIN PHIẾU</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Học viên</label>
                                <input type="text" class="form-control bg-light fw-bold text-dark" id="inp_name" readonly placeholder="--">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Khóa học</label>
                                <input type="text" class="form-control bg-light fw-bold text-dark text-wrap-custom" id="inp_course" readonly placeholder="--">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label small fw-bold">Nội dung thu</label>
                                <input type="text" name="content" id="inp_content" class="form-control" placeholder="Nhập nội dung...">
                            </div>
                             <div class="col-md-4">
                                <label class="form-label small fw-bold">Ngày lập</label>
                                <input type="date" name="created_date" class="form-control bg-light text-center"
                                       value="{{ today_str }}" readonly style="pointer-events: none;">
                            </div>
                        </div>

                        <h6 class="text-muted fw-bold small">2. CHI TIẾT THANH TOÁN</h6>
                        <div class="row g-3" >
                             <div class="col-md-6">
                                <label class="form-label small fw-bold">Số tiền đóng:</label>
                                <input type="number" name="amount" id="inp_amount" class="form-control style-fix" placeholder="0">
                             </div>
                             <div class="col-md-6">
                                <label class="form-label small fw-bold">Hình thức:</label>
                                {% for p in payment_methods %}
                                <label class="list-group-item align-items-center methods" >
                                    <input class="form-check-input" type="radio" name="payment_method"
                                           value="{{p.value}}">
                                    <div>
                                        <h6 class="mb-0 methodName">{{p.name}}</h6>
                                    </div>
                                </label>
                                {% endfor %}
                             </div>
                             <div class="col-12">
                                 <small class="text-info fst-italic">
                                     <i class="fa fa-info-circle"></i> Vui lòng chọn học viên từ danh sách bên trái để điền thông tin tự động.
                                 </small>
                             </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <button type="submit" formaction="{{ url_for('invoice.delete_regis') }}"
                                    onclick="return confirm('CẢNH BÁO: Bạn có chắc chắn muốn XÓA bản đăng ký này? Hành động này không thể hoàn tác.')"
                                    class="btn btn-outline-danger mr-4" id="btnDelete" disabled>
                                <i class="fa fa-trash me-2"></i> Xóa Đăng Ký
                            </button>

                            <button type="submit" formaction="{{ url_for('invoice.index') }}"
                                    class="btn btn-orange fw-bold shadow-sm" id="btnSubmit" disabled>
                                <i class="fa fa-print me-2"></i> LẬP PHIẾU THU
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="manualInvoiceModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow">

            <form action="{{ url_for('invoice.create_manual') }}" method="POST">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="fa fa-plus-circle me-2"></i>Tạo Đăng Ký & Thu Tiền
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body p-4 bg-light">

                    <div class="bg-white p-3 border mb-3">
                        <h6 class="fw-bold text-primary mb-3">1. Chọn Học Viên</h6>
                        <select class="form-control form-select style-fix" name="student_id" required>
                            <option value="">-- Chọn học viên từ hệ thống --</option>
                            {% for s in students %}
                            <option value="{{ s.id }}">{{ s.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="bg-white p-3 rounded border mb-3">
                        <h6 class="fw-bold text-primary mb-3">2. Chọn Lớp Học</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="small fw-bold text-muted">Khóa học</label>
                                <select id="modalCourseSelect" class="form-control form-select style-fix" required>
                                    <option value="">-- Chọn khóa --</option>
                                    {% for c in courses %}
                                    <option value="{{ c.id }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="small fw-bold text-muted">Cấp độ</label>
                                <select id="modalLevelSelect" class="form-control form-select style-fix" required>
                                    <option value="">-- Chọn cấp độ --</option>
                                    {% for l in levels %}
                                    <option value="{{ l.id }}">{{ l.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="table-scrollable-body bg-white">
                            <table class="table table-bordered table-hover text-center mb-0 table-sm">
                                <thead class="bg-light text-muted small">
                                    <tr>
                                        <th width="50">Chọn</th>
                                        <th>Mã</th>
                                        <th>Khai giảng</th>
                                        <th>Sĩ số</th>
                                    </tr>
                                </thead>
                                <tbody id="modalTableClasses">
                                    <tr><td colspan="4" class="text-muted small py-3">Vui lòng chọn khóa và cấp độ</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-3 rounded border">
                        <h6 class="fw-bold text-primary mb-3">3. Thanh Toán</h6>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="fw-bold small text-muted d-block mb-2">Hình thức:</label>
                                <div class="d-flex gap-3">
                                    {% for p in payment_methods %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method"
                                               value="{{p.value}}" id="pm_{{p.value}}" required>
                                        <label class="form-check-label" for="pm_{{p.value}}">{{ p.name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="fw-bold small text-muted d-block mb-2">Mức đóng:</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_percent"
                                               value="100" id="pp_100" checked>
                                        <label class="form-check-label" for="pp_100">100% (Toàn bộ)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_percent"
                                               value="50" id="pp_50">
                                        <label class="form-check-label" for="pp_50">50% (Cọc)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-white border-top-0">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary fw-bold px-4">Tạo Hóa Đơn</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

    // --- Logic cho Modal Tự tạo hóa đơn (Load Classes bằng AJAX) ---
    const courseSel = document.getElementById('modalCourseSelect');
    const levelSel = document.getElementById('modalLevelSelect');
    const tableBody = document.getElementById('modalTableClasses');

    function loadClassesForModal() {
        const c_id = courseSel.value;
        const l_id = levelSel.value;

        if (c_id && l_id) {
            // Hiển thị trạng thái đang tải
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3"><i class="fa fa-spinner fa-spin"></i> Đang tải danh sách lớp...</td></tr>';

            fetch(`{{ url_for('invoice.load_classes') }}?course_id=${c_id}&level_id=${l_id}`)
                .then(res => res.json())
                .then(data => {
                    tableBody.innerHTML = "";

                    if (!data || data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">Không có lớp học phù hợp.</td></tr>';
                        return;
                    }

                    // Render danh sách lớp
                    data.forEach(c => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><input type="radio" name="class_id" value="${c.id}" required></td>
                            <td class="fw-bold">Lớp ${c.id}</td>
                            <td>${c.start_time}</td>
                            <td><span class="badge bg-light text-dark border">${c.current_count}/${c.maximum_stu}</span></td>
                        `;
                        tableBody.appendChild(tr);
                    });
                })
                .catch(err => {
                    console.error(err);
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">Lỗi kết nối máy chủ.</td></tr>';
                });
        }
    }

    // Gắn sự kiện change cho dropdown
    courseSel.addEventListener('change', loadClassesForModal);
    levelSel.addEventListener('change', loadClassesForModal);
</script>

{% endblock %}