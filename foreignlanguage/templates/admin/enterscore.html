{% extends 'admin/master.html' %}

{% block body %}
<h4 class="fw-bold">Nhập điểm</h4>

<form method="post" action="{{ url_for('enterscore.save_scores') }}">
    <div class="border p-3 rounded bg-orange-light">
        <label class="fw-bold">Chọn lớp: </label>
        <select class="form-select mb-3" style="width: 30%; min-width: 400px; padding: 10px;"
                onchange="location='?class_id=' + this.value">
            <option value="">-- Chọn lớp --</option>
            {% for c in classes %}
            <option value="{{ c.id }}" {% if c.id== selected_class %}selected{% endif %}>
                {{ c.course_level.course.name }} - {{ c.course_level.level.name }} (Mã lớp: {{ c.id }})
            </option>
            {% endfor %}
        </select>

        <table class="table table-bordered text-center">
            <thead class="bg-orange">
            <tr>
                <th>STT</th>
                <th>Tên học viên</th>
                {% for c in categories %}
                <th>{{ c.name }}</th>
                {% endfor %}
                <th>Điểm TB</th>
                <th>Kết quả</th>
                <th>Xếp loại</th>
            </tr>
            </thead>

            <tbody>
            {% for item in students %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ item.reg.student.account.name }}</td>

                {% for c in categories %}
                {% set val = item.scores[c.id] %}
                <td>
                    <input type="number"
                           class="form-control score-input"
                           name="score_{{ item.reg.id }}_{{ c.id }}"
                           value="{{ val if val is not none else 0 }}"
                           data-weight="{{ c.weight }}"
                           min="0"
                           max="10"
                           step="0.1"
                           oninput="
           if (this.value === '') this.value = 0;
           if (this.value < 0) this.value = 0;
           if (this.value > 10) this.value = 10;
           updateDTB.call(this);
       ">

                </td>
                {% endfor %}

                <td class="dtb">{{ "%.2f"|format(item.dtb) }}</td>
                <input type="hidden" name="final_score_{{ item.reg.id }}" class="hidden-dtb" value="{{ item.dtb }}">
                <input type="hidden" name="status_{{ item.reg.id }}" class="hidden-status"
                       value="{{ 'PASSED' if item.dtb >= 5 else 'FAILED' }}">
                <td class="result">{{ "Đậu" if item.dtb >=5 else "Rớt" }}</td>
                <td class="rank">
                    {% if item.dtb >= 8 %}Giỏi
                    {% elif item.dtb >=6.5 %}Khá
                    {% elif item.dtb >=5 %}Trung bình
                    {% else %}Yếu
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <button type="submit" class="btn btn-orange px-4 rounded-3">Lưu điểm</button>
    </div>
</form>
<script src="{{ url_for('static', filename='js/teacher.js') }}"></script>

{% endblock %}